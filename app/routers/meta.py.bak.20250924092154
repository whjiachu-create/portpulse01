from fastapi import APIRouter, Request, Response
from datetime import datetime, timezone
from hashlib import sha256
import json
import os

router = APIRouter(prefix="/v1", tags=["meta"])

def _bucket_now_utc(minutes: int = 5) -> datetime:
    now = datetime.now(timezone.utc).replace(microsecond=0)
    bucket_minute = (now.minute // minutes) * minutes
    return now.replace(minute=bucket_minute, second=0)

def _make_meta_payload(now_buck: datetime):
    return {
        "sources": [
            {"name": "demo", "type": "synthetic", "freshness": "PT30M", "last_updated": "2025-09-17T00:00:00Z"}
        ],
        "etl": {"window": "hourly", "retries": 2, "backfill": "30d"},
        "build": {
            "version": os.getenv("PORTPULSE_VERSION", "0.1.1"),
            "commit": os.getenv("PORTPULSE_COMMIT")
        },
        "updated_at": now_buck.isoformat()
    }

def _json_body_and_headers(payload: dict) -> tuple[bytes, dict]:
    body = json.dumps(payload, sort_keys=True, separators=(",", ":")).encode("utf-8")
    etag = '"' + sha256(body).hexdigest() + '"'
    headers = {
        "ETag": etag,
        "Cache-Control": "public, max-age=300, no-transform",
        "Content-Type": "application/json; charset=utf-8",
        "Vary": "Accept-Encoding",
    }
    return body, headers

def _maybe_304(request: Request, headers: dict) -> Response | None:
    inm = request.headers.get("if-none-match")
    if not inm:
        return None
    for s in (h.strip() for h in inm.split(",")):
        if s == headers["ETag"] or s == f'W/{headers["ETag"]}':
            return Response(status_code=304, headers=headers)
    return None

@router.get("/health", summary="Liveness/Readiness")
def health():
    return {"ok": True, "ts": datetime.now(timezone.utc).isoformat()}

@router.get("/meta/sources", summary="Data sources & ETL metadata")
def meta_sources(request: Request):
    now_buck = _bucket_now_utc(5)
    payload = _make_meta_payload(now_buck)
    body, headers = _json_body_and_headers(payload)
    maybe = _maybe_304(request, headers)
    if maybe:
        return maybe
    return Response(content=body, headers=headers)

@router.head("/meta/sources", summary="HEAD for /meta/sources")
def head_meta_sources(request: Request):
    now_buck = _bucket_now_utc(5)
    payload = _make_meta_payload(now_buck)
    _body, headers = _json_body_and_headers(payload)
    maybe = _maybe_304(request, headers)
    if maybe:
        return maybe
    return Response(status_code=200, headers=headers)

@router.get("/sources", summary="(alias) Data sources & ETL metadata")
def sources_alias(request: Request):
    return meta_sources(request)

@router.head("/sources", summary="(alias) HEAD for /sources")
def head_sources_alias(request: Request):
    return head_meta_sources(request)
