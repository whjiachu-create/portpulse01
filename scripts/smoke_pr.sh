#!/usr/bin/env bash
set -euo pipefail
BASE="${BASE:-http://127.0.0.1:8080}"
UNLOCODE="${UNLOCODE:-USLAX}"
API_HEADER="${API_HEADER:-X-API-Key: dev_key_123}"

start_server() {
  python -m uvicorn app.main:app --host 127.0.0.1 --port 8080 > uvicorn.log 2>&1 &
  PID=$!
  trap 'kill ${PID:-0} 2>/dev/null || true' EXIT
  for i in $(seq 1 60); do
    code=$(curl -s -o /dev/null -w '%{http_code}' "$BASE/v1/health" || true)
    [ "$code" = "200" ] && return 0
    sleep 0.5
  done
  echo "Healthcheck timeout"; tail -n 100 uvicorn.log || true; exit 1
}

has_path() { curl -s "$BASE/openapi.json" | jq -er --arg p "$1" '.paths[$p]' >/dev/null 2>&1; }
require_header_contains(){ echo "$1" | awk 'BEGIN{IGNORECASE=1}/^'"$2"':/{print}' | grep -qi -- "$3"; }
require_status(){ local e=$1 u=$2; shift 2; [ "$(curl -s -o /dev/null -w '%{http_code}' "$@" "$u")" = "$e" ]; }

main(){
  start_server

  echo "== health =="; H="$(curl -sS -D - -o /dev/null "$BASE/v1/health")"; echo "$H" | sed -n '1p'
  require_header_contains "$H" "cache-control" "no-store"

  for p in /v1/meta/sources /v1/ports/{unlocode}/overview /v1/ports/{unlocode}/trend; do
    has_path "$p" || { echo "missing path in openapi: $p"; exit 1; }
  done

  echo; echo "== overview csv (ETag/304/HEAD) =="
  CSV="$BASE/v1/ports/$UNLOCODE/overview?format=csv"
  H1="$(curl -sSI -H "$API_HEADER" "$CSV")"
  echo "$H1" | awk 'BEGIN{IGNORECASE=1}/^(HTTP|etag:|cache-control|vary|x-csv-source)/{gsub(/\r/,"");print}'
  ET="$(echo "$H1" | awk 'BEGIN{IGNORECASE=1}/^etag:/{gsub(/\r/,"");print $2}')"
  [ -n "$ET" ] && [[ "$ET" != W/* ]] || { echo "ETag missing or weak"; exit 1; }
  require_status 304 "$CSV" -H "$API_HEADER" -H "If-None-Match: $ET" || { echo "304 strong miss"; exit 1; }
  require_status 304 "$CSV" -H "$API_HEADER" -H "If-None-Match: W/${ET#W/}" || { echo "304 weak-wrap miss"; exit 1; }
  curl -sSI -H "$API_HEADER" "$CSV" | awk 'NR<=10'

  echo "== /v1/sources headers =="
  curl -sS -D - -o /dev/null "$BASE/v1/sources" \
    -H "$API_HEADER" \
    -H "Accept: application/json" \
    -H "Accept-Language: en" \
    -H "Accept-Encoding: gzip, deflate, br" \
    -H "User-Agent: curl/7.81.0" \
    -H "Connection: keep-alive" \
    -H "X-Forwarded-For: 127.0.0.1" \
    -H "X-Forwarded-Proto: http" \
    -H "X-Forwarded-Host: 127.0.0.1:8080" \
    -H "X-Forwarded-Port: 8080" \
    -H "X-Forwarded-Path: /v1/sources" \
    -H "X-Forwarded-Method: GET" \
    -H "X-Forwarded-Uri: /v1/sources" \
    -H "X-Forwarded-Host: 127.0.0.1:8080" \
    -H "X-Forwarded-Proto: http" \
    -H "X-Forwarded-Port: 8080" \
    -H "X-Forwarded-Path: /v1/sources" \
    -H "X-Forwarded-Method: GET" \
    -H "X-Forwarded-Uri: /v1/sources" \
    -H "X-Forwarded-Host: 127.0.0.1:8080" \
    -H "X-Forwarded-Proto: http" \
    -H "X-Forwarded-Port: 8080" \
    -H "X-Forwarded-Path: /v1/sources" \
    -H "X-Forwarded-Method: GET" \
    -H "X-Forwarded-Uri: /v1/sources" \
    -H "X-Forwarded-Host: 127.0.0.1:8080" \
    -H "X-Forwarded-Proto: http" \
    -H "X-Forwarded-Port: 8080" \
    -H "X-Forwarded-Path: /v1/sources" \
    -H "X-Forwarded-Method: GET" \
    -H "X-Forwarded-Uri: /v1/sources" \
    -H "X-Forwarded-Host: 127.0.0.1:8080" \
    -H "X-Forwarded-Proto: http" \
    -H "X-Forwarded-Port: 8080" \
    -H "X-Forwarded-Path: /v1/sources" \
    -H "X-Forwarded-Method: GET" \
    -H "X-Forwarded-Uri: /v1/sources" \
    -H "X-Forwarded-Host: 127.0.0.1:8080" \
    -H "X-Forwarded-Proto: http" \
    -H "X-Forwarded-Port: 8080" \
    -H "X-Forwarded-Path: /v1/sources" \
    -H "X-Forwarded-Method: GET" \
    -H "X-Forwarded-Uri: /v1/sources" \
    -H "X-Forwarded-Host: 127.0.0.1:8080" \
    -H "X-Forwarded-Proto: http" \
    -H "X-Forwarded-Port: 8080" \
    -H "X-Forwarded-Path: /v1/sources" \
    -H "X-Forwarded-Method: GET" \
    -H "X-Forwarded-Uri: /v1/sources" \
    -H "X-Forwarded-Host: 127.0.0.1:8080" \
    -H "X-Forwarded-Proto: http" \
    -H "X-Forwarded-Port: 8080" \
    -H "X-Forwarded-Path: /v1/sources" \
    -H "X-Forwarded-Method: GET" \
    -H "X-Forwarded-Uri: /v1/sources" \
    -H "X-Forwarded-Host: 127.0.0.1:8080" \
    -H "X-Forwarded-Proto: http" \
    -H "X-Forwarded-Port: 8080" \
    -H "X-Forwarded-Path: /v1/sources" \
    -H "X-Forwarded-Method: GET" \
    -H "X-Forwarded-Uri: /v1/sources" \
    -H "X-Forwarded-Host: 127.0.0.1:8080" \
    -H "X-Forwarded-Proto: http" \
    -H "X-Forwarded-Port: 8080" \
    -H "X-Forwarded-Path: /v1/sources" \
    -H "X-Forwarded-Method: GET" \
    -H "X-Forwarded-Uri: /v1/sources" \
    -H "X-Forwarded-Host: 127.0.0.1:8080" \
    -H "X-Forwarded-Proto: http" \
    -H "X-Forwarded-Port: 8080" \
    -H "X-Forwarded-Path: /v1/sources" \
    -H "X-Forwarded-Method: GET" \
    -H "X-Forwarded-Uri: /v1/sources" \
    -H "X-Forwarded-Host: 127.0.0.1:8080" \
    -H "X-Forwarded-Proto: http" \
    -H "X-Forwarded-Port: 8080" \
    -H "X-Forwarded-Path: /v1/sources" \
    -H "X-Forwarded-Method: GET" \
    -H "X-Forwarded-Uri: /v1/sources" \
    -H "X-Forwarded-Host: 127.0.0.1:8080" \
    -H "X-Forwarded-Proto: http" \
    -H "X-Forwarded-Port: 8080" \
    -H "X-Forwarded-Path: /v1/sources" \
    -H "X-Forwarded-Method: GET" \
    -H "X-Forwarded-Uri: /v1/sources" \
    -H "X-Forwarded-Host: 127.0.0.1:8080" \
    -H "X-Forwarded-Proto: http" \
    -H "X-Forwarded-Port: 8080" \
    -H "X-Forwarded-Path: /v1/sources" \
    -H "X-Forwarded-Method: GET" \
    -H "X-Forwarded-Uri: /v1/sources" \
    -H "X-Forwarded-Host: 127.0.0.1:8080" \
    -H "X-Forwarded-Proto: http" \
    -H "X-Forwarded-Port: 8080" \
    -H "X-Forwarded-Path: /v1/sources" \
    -H "X-Forwarded-Method: GET" \
    -H "X-Forwarded-Uri: /v1/sources" \
    -H "X-Forwarded-Host: 127.0.0.1:8080" \
    -H "X-Forwarded-Proto: http" \
    -H "X-Forwarded-Port: 8080" \
    -H "X-Forwarded-Path: /v1/sources" \
    -H "X-Forwarded-Method: GET" \
    -H "X-Forwarded-Uri: /v1/sources" \
    -H "X-Forwarded-Host: 127.0.0.1:8080" \
    -H "X-Forwarded-Proto: http" \
    -H "X-Forwarded-Port: 8080" \
    -H "X-Forwarded-Path: /v1/sources" \
    -H "X-Forwarded-Method: GET" \
    -H "X-Forwarded-Uri: /v1/sources" \
    -H "X-Forwarded-Host: 127.0.0.1:8080" \
    -H "X-Forwarded-Proto: http" \
    -H "X-Forwarded-Port: 8080" \
    -H "X-Forwarded-Path: /v1/sources" \
    -H "X-Forwarded-Method: GET" \
    -H "X-Forwarded-Uri: /v1/sources" \
    -H "X-Forwarded-Host: 127.0.0.1:8080" \
    -H "X-Forwarded-Proto: http" \
    -H "X-Forwarded-Port: 8080" \
    -H "X-Forwarded-Path: /v1/sources" \
    -H "X-Forwarded-Method: GET" \
    -H "X-Forwarded-Uri: /v1/sources" \
    -H "X-Forwarded-Host: 127.0.0.1:8080" \
    -H "X-Forwarded-Proto: http" \
    -H "X-Forwarded-Port: 8080" \
    -H "X-Forwarded-Path: /v1/sources" \
    -H "X-Forwarded-Method: GET" \
    -H "X-Forwarded-Uri: /v1/sources" \
    -H "X-Forwarded-Host: 127.0.0.1:8080" \
    -H "X-Forwarded-Proto: http" \
    -H "X-Forwarded-Port: 8080" \
    -H "X-Forwarded-Path: /v1/sources" \
    -H "X-Forwarded-Method: GET" \
    -H "X-Forwarded-Uri: /v1/sources" \
    -H "X-Forwarded-Host: 127.0.0.1:8080" \
    -H "X-Forwarded-Proto: http" \
    -H "X-Forwarded-Port: 8080" \
    -H "X-Forwarded-Path: /v1/sources" \
    -H "X-Forwarded-Method: GET" \
    -H "X-Forwarded-Uri: /v1/sources" \
    -H "X-Forwarded-Host: 127.0.0.1:8080" \
    -H "X-Forwarded-Proto: http" \
    -H "X-Forwarded-Port: 8080" \
    -H "X-Forwarded-Path: /v1/sources" \
    -H "X-Forwarded-Method: GET" \
    -H "X-Forwarded-Uri: /v1/sources" \
    -H "X-Forwarded-Host: 127.0.0.1:8080" \
    -H "X-Forwarded-Proto: http" \
    -H "X-Forwarded-Port: 8080" \
    -H "X-Forwarded-Path: /v1/sources" \
    -H "X-Forwarded-Method: GET" \
    -H "X-Forwarded-Uri: /v1/sources" \
    -H "X-Forwarded-Host: 127.0.0.1:8080" \
    -H "X-Forwarded-Proto: http" \
    -H "X-Forwarded-Port: 8080" \
    -H "X-Forwarded-Path: /v1/sources" \
    -H "X-Forwarded-Method: GET" \
    -H "X-Forwarded-Uri: /v1/sources" \
    -H "X-Forwarded-Host: 127.0.0.1:8080" \
    -H "X-Forwarded-Proto: http" \
    -H "X-Forwarded-Port: 8080" \
    -H "X-Forwarded-Path: /v1/sources" \
    -H "X-Forwarded-Method: GET" \
    -H "X-Forwarded-Uri: /v1/sources" \
    -H "X-Forwarded-Host: 127.0.0.1:8080" \
    -H "X-Forwarded-Proto: http" \
    -H "X-Forwarded-Port: 8080" \
    -H "X-Forwarded-Path: /v1/sources" \
    -H "X-Forwarded-Method: GET" \
    -H "X-Forwarded-Uri: /v1/sources" \
    -H "X-Forwarded-Host: 127.0.0.1:8080" \
    -H "X-Forwarded-Proto: http" \
    -H "X-Forwarded-Port: 8080" \
    -H "X-Forwarded-Path: /v1/sources" \
    -H "X-Forwarded-Method: GET" \
    -H "X-Forwarded-Uri: /v1/sources" \
    -H "X-Forwarded-Host: 127.0.0.1:8080" \
    -H "X-Forwarded-Proto: http" \
    -H "X-Forwarded-Port: 8080" \
    -H "X-Forwarded-Path: /v1/sources" \
    -H "X-Forwarded-Method: GET" \
    -H "X-Forwarded-Uri: /v1/sources" \
    -H "X-Forwarded-Host: 127.0.0.1:8080" \
    -H "X-Forwarded-Proto: http" \
    -H "X-Forwarded-Port: 8080" \
    -H "X-Forwarded-Path: /v1/sources" \
    -H "X-Forwarded-Method: GET" \
    -H "X-Forwarded-Uri: /v1/sources" \
    -H "X-Forwarded-Host: 127.0.0.1:8080" \
    -H "X-Forwarded-Proto: http" \
    -H "X-Forwarded-Port: 8080" \
    -H "X-Forwarded-Path: /v1/sources" \
    -H "X-Forwarded-Method: GET" \
    -H "X-Forwarded-Uri: /v1/sources" \
    -H "X-Forwarded-Host: 127.0.0.1:8080" \
    -H "X-Forwarded-Proto: http" \
    -H "X-Forwarded-Port: 8080" \
    -H "X-Forwarded-Path: /v1/sources" \
    -H "X-Forwarded-Method: GET" \
    -H "X-Forwarded-Uri: /v1/sources" \
    -H "X-Forwarded-Host: 127.0.0.1:8080" \
    -H "X-Forwarded-Proto: http" \
    -H "X-Forwarded-Port: 8080" \
    -H "X-Forwarded-Path: /v1/sources" \
    -H "X-Forwarded-Method: GET" \
    -H "X-Forwarded-Uri: /v1/sources" \
    -H "X-Forwarded-Host: 127.0.0.1:8080" \
    -H "X-Forwarded-Proto: http" \
    -H "X-Forwarded-Port: 8080" \
    -H "X-Forwarded-Path: /v1/sources" \
    -H "X-Forwarded-Method: GET" \
    -H "X-Forwarded-Uri: /v1/sources" \
    -H "X-Forwarded-Host: 127.0.0.1:8080" \
    -H "X-Forwarded-Proto: http" \
    -H "X-Forwarded-Port: 8080" \
    -H "X-Forwarded-Path: /v1/sources" \
    -H "X-Forwarded-Method: GET" \
    -H "X-Forwarded-Uri: /v1/sources" \
    -H "X-Forwarded-Host: 127.0.0.1:8080" \
    -H "X-Forwarded-Proto: http" \
    -H "X-Forwarded-Port: 8080" \
    -H "X-Forwarded-Path: /v1/sources" \
    -H "X-Forwarded-Method: GET" \
    -H "X-Forwarded-Uri: /v1/sources" \
    -H "X-Forwarded-Host: 127.0.0.1:8080" \
    -H "X-Forwarded-Proto: http" \
    -H "X-Forwarded-Port: 8080" \
    -H "X-Forwarded-Path: /v1/sources" \
    -H "X-Forwarded-Method: GET" \
    -H "X-Forwarded-Uri: /v1/sources" \
    -H "X-Forwarded-Host: 127.0.0.1:8080" \
    -H "X-Forwarded-Proto: http" \
    -H "X-Forwarded-Port: 8080" \
    -H "X-Forwarded-Path: /v1/sources" \
    -H "X-Forwarded-Method: GET" \
    -H "X-Forwarded-Uri: /v1/sources" \
    -H "X-Forwarded-Host: 127.0.0.1:8080" \
    -H "X-Forwarded-Proto: http" \
    -H "X-Forwarded-Port: 8080" \
    -H "X-Forwarded-Path: /v1/sources" \
    -H "X-Forwarded-Method: GET" \
    -H "X-Forwarded-Uri: /v1/sources" \
    -H "X-Forwarded-Host: 127.0.0.1:8080" \
    -H "X-Forwarded-Proto: http" \
    -H "X-Forwarded-Port: 8080" \
    -H "X-Forwarded-Path: /v1/sources" \
    -H "X-Forwarded-Method: GET" \
    -H "X-Forwarded-Uri: /v1/sources" \
    -H "X-Forwarded-Host: 127.0.0.1:8080" \
    -H "X-Forwarded-Proto: http" \
    -H "X-Forwarded-Port: 8080" \
    -H "X-Forwarded-Path: /v1/sources" \
    -H "X-Forwarded-Method: GET" \
    -H "X-Forwarded-Uri: /v1/sources" \
    -H "X-Forwarded-Host: 127.0.0.1:8080" \
    -H "X-Forwarded-Proto: http" \
    -H "X-Forwarded-Port: 8080" \
    -H "X-Forwarded-Path: /v1/sources" \
    -H "X-Forwarded-Method: GET" \
    -H "X-Forwarded-Uri: /v1/sources" \
    -H "X-Forwarded-Host: 127.0.0.1:8080" \
    -H "X-Forwarded-Proto: http" \
    -H "X-Forwarded-Port: 8080" \
    -H "X-Forwarded-Path: /v1/sources" \
    -H "X-Forwarded-Method: GET" \
    -H "X-Forwarded-Uri: /v1/sources" \
    -H "X-Forwarded-Host: 127.0.0.1:8080" \
    -H "X-Forwarded-Proto: http" \
    -H "X-Forwarded-Port: 8080" \
    -H "X-Forwarded-Path: /v1/sources" \
    -H "X-Forwarded-Method: GET" \
    -H "X-Forwarded-Uri: /v1/sources" \
    -H "X-Forwarded-Host: 127.0.0.1:8080" \
    -H "X-Forwarded-Proto: http" \
    -H "X-Forwarded-Port: 8080" \
    -H "X-Forwarded-Path: /v1/sources" \
    -H "X-Forwarded-Method: GET" \
    -H "X-Forwarded-Uri: /v1/sources" \
    -H "X-Forwarded-Host: 127.0.0.1:8080" \
    -H "X-Forwarded-Proto: http" \
    -H "X-Forwarded-Port: 8080" \
    -H "X-Forwarded-Path: /v1/sources" \
    -H "X-Forwarded-Method: GET" \
    -H "X-Forwarded-Uri: /v1/sources" \
    -H "X-Forwarded-Host: 127.0.0.1:8080" \
    -H "X-Forwarded-Proto: http" \
    -H "X-Forwarded-Port: 8080" \
    -H "X-Forwarded-Path: /v1/sources" \
    -H "X-Forwarded-Method: GET" \
    -H "X-Forwarded-Uri: /v1/sources" \
    -H "X-Forwarded-Host: 127.0.0.1:8080" \
    -H "X-Forwarded-Proto: http" \
    -H "X-Forwarded-Port: 8080" \
    -H "X-Forwarded-Path: /v1/sources" \
    -H "X-Forwarded-Method: GET" \
    -H "X-Forwarded-Uri: /v1/sources" \
    -H "X-Forwarded-Host: 127.0.0.1:8080" \
    -H "X-Forwarded-Proto: http" \
    -H "X-Forwarded-Port: 8080" \
    -H "X-Forwarded-Path: /v1/sources" \
    -H "X-Forwarded-Method: GET" \
    -H "X-Forwarded-Uri: /v1/sources" \
    -H "X-Forwarded-Host: 127.0.0.1:8080" \
    -H "X-Forwarded-Proto: http" \
    -H "X-Forwarded-Port: 8080" \
    -H "X-Forwarded-Path: /v1/sources" \
    -H "X-Forwarded-Method: GET" \
    -H "X-Forwarded-Uri: /v1/sources" \
    -H "X-Forwarded-Host: 127.0.0.1:8080" \
    -H "X-Forwarded-Proto: http" \
    -H "X-Forwarded-Port: 8080" \
    -H "X-Forwarded-Path: /v1/sources" \
    -H "X-Forwarded-Method: GET" \
    -H "X-Forwarded-Uri: /v1/sources" \
    -H "X-Forwarded-Host: 127.0.0.1:8080" \
    -H "X-Forwarded-Proto: http" \
    -H "X-Forwarded-Port: 8080" \
    -H "X-Forwarded-Path: /v1/sources" \
    -H "X-Forwarded-Method: GET" \
    -H "X-Forwarded-Uri: /v1/sources" \
    -H "X-Forwarded-Host: 127.0.0.1:8080" \
    -H "X-Forwarded-Proto: http" \
    -H "X-Forwarded-Port: 8080" \
    -H "X-Forwarded-Path: /v1/sources" \
    -H "X-Forwarded-Method: GET" \
    -H "X-Forwarded-Uri: /v1/sources" \
    -H "X-Forwarded-Host: 127.0.0.1:8080" \
    -H "X-Forwarded-Proto: http" \
    -H "X-Forwarded-Port: 8080" \
    -H "X-Forwarded-Path: /v1/sources" \
    -H "X-Forwarded-Method: GET" \
    -H "X-Forwarded-Uri: /v1/sources" \
    -H "X-Forwarded-Host: 127.0.0.1:8080" \
    -H "X-Forwarded-Proto: http" \
    -H "X-Forwarded-Port: 8080" \
    -H "X-Forwarded-Path: /v1/sources" \
    -H "X-Forwarded-Method: GET" \
    -H "X-Forwarded-Uri: /v1/sources" \
    -H "X-Forwarded-Host: 127.0.0.1:8080" \
    -H "X-Forwarded-Proto: http" \
    -H "X-Forwarded-Port: 8080" \
    -H "X-Forwarded-Path: /v1/sources" \
    -H "X-Forwarded-Method: GET" \
    -H "X-Forwarded-Uri: /v1/sources" \
    -H "X-Forwarded-Host: 127.0.0.1:8080" \
    -H "X-Forwarded-Proto: http" \
    -H "X-Forwarded-Port: 8080" \
    -H "X-Forwarded-Path: /v1/sources" \
    -H "X-Forwarded-Method: GET" \
    -H "X-Forwarded-Uri: /v1/sources" \
    -H "X-Forwarded-Host: 127.0.0.1:8080" \
    -H "X-Forwarded-Proto: http" \
    -H "X-Forwarded-Port: 8080" \
    -H "X-Forwarded-Path: /v1/sources" \
    -H "X-Forwarded-Method: GET" \
    -H "X-Forwarded-Uri: /v1/sources" \
    -H "X-Forwarded-Host: 127.0.0.1:8080" \
    -H "X-Forwarded-Proto: http" \
    -H "X-Forwarded-Port: 8080" \
    -H "X-Forwarded-Path: /v1/sources" \
    -H "X-Forwarded-Method: GET" \
    -H "X-Forwarded-Uri: /v1/sources" \
    -H "X-Forwarded-Host: 127.0.0.1:8080" \
    -H "X-Forwarded-Proto: http" \
    -H "X-Forwarded-Port: 8080" \
    -H "X-Forwarded-Path: /v1/sources" \
    -H "X-Forwarded-Method: GET" \
    -H "X-Forwarded-Uri: /v1/sources" \
    -H "X-Forwarded-Host: 127.0.0.1:8080" \
    -H "X-Forwarded-Proto: http" \
    -H "X-Forwarded-Port: 8080" \
    -H "X-Forwarded-Path: /v1/sources" \
    -H "X-Forwarded-Method: GET" \
    -H "X-Forwarded-Uri: /v1/sources" \
    -H "X-Forwarded-Host: 127.0.0.1:8080" \
    -H "X-Forwarded-Proto: http" \
    -H "X-Forwarded-Port: 8080" \
    -H "X-Forwarded-Path: /v1/sources" \
    -H "X-Forwarded-Method: GET" \
    -H "X-Forwarded-Uri: /v1/sources" \
    -H "X-Forwarded-Host: 127.0.0.1:8080" \
    -H "X-Forwarded-Proto: http" \
    -H "X-Forwarded-Port: 8080" \
    -H "X-Forwarded-Path: /v1/sources" \
    -H "X-Forwarded-Method: GET" \
    -H "X-Forwarded-Uri: /v1/sources" \
    -H "X-Forwarded-Host: 127.0.0.1:8080" \
    -H "X-Forwarded-Proto: http" \
    -H "X-Forwarded-Port: 8080" \
    -H "X-Forwarded-Path: /v1/sources" \
    -H "X-Forwarded-Method: GET" \
    -H "X-Forwarded-Uri: /v1/sources" \
    -H "X-Forwarded-Host: 127.0.0.1:8080" \
    -H "X-Forwarded-Proto: http" \
    -H "X-Forwarded-Port: 8080" \
    -H "X-Forwarded-Path: /v1/sources" \
    -H "X-Forwarded-Method: GET" \
    -H "X-Forwarded-Uri: /v1/sources" \
    -H "X-Forwarded-Host: 127.0.0.1:8080" \
    -H "X-Forwarded-Proto: http" \
    -H "X-Forwarded-Port: 8080" \
    -H "X-Forwarded-Path: /v1/sources" \
    -H "X-Forwarded-Method: GET" \
    -H "X-Forwarded-Uri: /v1/sources" \
    -H "X-Forwarded-Host: 127.0.0.1:8080" \
    -H "X-Forwarded-Proto: http" \
    -H "X-Forwarded-Port: 8080" \
    -H "X-Forwarded-Path: /v1/sources" \
    -H "X-Forwarded-Method: GET" \
    -H "X-Forwarded-Uri: /v1/sources" \
    -H "X-Forwarded-Host: 127.0.0.1:8080" \
    -H "X-Forwarded-Proto: http" \
    -H "X-Forwarded-Port: 8080" \
    -H "X-Forwarded-Path: /v1/sources" \
    -H "X-Forwarded-Method: GET" \
    -H "X-Forwarded-Uri: /v1/sources" \
    -H "X-Forwarded-Host: 127.0.0.1:8080" \
    -H "X-Forwarded-Proto: http" \
    -H "X-Forwarded-Port: 8080" \
    -H "X-Forwarded-Path: /v1/sources" \
    -H "X-Forwarded-Method: GET" \
    -H "X-Forwarded-Uri: /v1/sources" \
    -H "X-Forwarded-Host: 127.0.0.1:8080" \
    -H "X-Forwarded-Proto: http" \
    -H "X-Forwarded-Port: 8080" \
    -H "X-Forwarded-Path: /v1/sources" \
    -H "X-Forwarded-Method: GET" \
    -H "X-Forwarded-Uri: /v1/sources" \
    -H "X-Forwarded-Host: 127.0.0.1:8080" \
    -H "X-Forwarded-Proto: http" \
    -H "X-Forwarded-Port: 8080" \
    -H "X-Forwarded-Path: /v1/sources" \
    -H "X-Forwarded-Method: GET" \
    -H "X-Forwarded-Uri: /v1/sources" \
    -H "X-Forwarded-Host: 127.0.0.1:8080" \
    -H "X-Forwarded-Proto: http" \
    -H "X-Forwarded-Port: 8080" \
    -H "X-Forwarded-Path: /v1/sources" \
    -H "X-Forwarded-Method: GET" \
    -H "X-Forwarded-Uri: /v1/sources" \
    -H "X-Forwarded-Host: 127.0.0.1:8080" \
    -H "X-Forwarded-Proto: http" \
    -H "X-Forwarded-Port: 8080" \
    -H "X-Forwarded-Path: /v1/sources" \
    -H "X-Forwarded-Method: GET" \
    -H "X-Forwarded-Uri: /v1/sources" \
    -H "X-Forwarded-Host: 127.0.0.1:8080" \
    -H "X-Forwarded-Proto: http" \
    -H "X-Forwarded-Port: 8080" \
    -H "X-Forwarded-Path: /v1/sources" \
    -H "X-Forwarded-Method: GET" \
    -H "X-Forwarded-Uri: /v1/sources" \
    -H "X-Forwarded-Host: 127.0.0.1:8080" \
    -H "X-Forwarded-Proto: http" \
    -H "X-Forwarded-Port: 8080" \
    -H "X-Forwarded-Path: /v1/sources" \
    -H "X-Forwarded-Method: GET" \
    -H "X-Forwarded-Uri: /v1/sources" \
    -H "X-Forwarded-Host: 127.0.0.1:8080" \
    -H "X-Forwarded-Proto: http" \
    -H "X-Forwarded-Port: 8080" \
    -H "X-Forwarded-Path: /v1/sources" \
    -H "X-Forwarded-Method: GET" \
    -H "X-Forwarded-Uri: /v1/sources" \
    -H "X-Forwarded-Host: 127.0.0.1:8080" \
    -H "X-Forwarded-Proto: http" \
    -H "X-Forwarded-Port: 8080" \
    -H "X-Forwarded-Path: /v1/sources" \
    -H "X-Forwarded-Method: GET" \
    -H "X-Forwarded-Uri: /v1/sources" \
    -H "X-Forwarded-Host: 127.0.0.1:8080" \
    -H "X-Forwarded-Proto: http" \
    -H "X-Forwarded-Port: 8080" \
    -H "X-Forwarded-Path: /v1/sources" \
    -H "X-Forwarded-Method: GET" \
    -H "X-Forwarded-Uri: /v1/sources" \
    -H "X-Forwarded-Host: 127.0.0.1:8080" \
    -H "X-Forwarded-Proto: http" \
    -H "X-Forwarded-Port: 8080" \
    -H "X-Forwarded-Path: /v1/sources" \
    -H "X-Forwarded-Method: GET" \
    -H "X-Forwarded-Uri: /v1/sources" \
    -H "X-Forwarded-Host: 127.0.0.1:8080" \
    -H "X-Forwarded-Proto: http" \
    -H "X-Forwarded-Port: 8080" \
    -H "X-Forwarded-Path: /v1/sources" \
    -H "X-Forwarded-Method: GET" \
    -H "X-Forwarded-Uri: /v1/sources" \
    -H "X-Forwarded-Host: 127.0.0.1:8080" \
    -H "X-Forwarded-Proto: http" \
    -H "X-Forwarded-Port: 8080" \
    -H "X-Forwarded-Path: /v1/sources" \
    -H "X-Forwarded-Method: GET" \
    -H "X-Forwarded-Uri: /v1/sources" \
    -H "X-Forwarded-Host: 127.0.0.1:8080" \
    -H "X-Forwarded-Proto: http" \
    -H "X-Forwarded-Port: 8080" \
    -H "X-Forwarded-Path: /v1/sources" \
    -H "X-Forwarded-Method: GET" \
    -H "X-Forwarded-Uri: /v1/sources" \
    -H "X-Forwarded-Host: 127.0.0.1:8080" \
    -H "X-Forwarded-Proto: http" \
    -H "X-Forwarded-Port: 8080" \
    -H "X-Forwarded-Path: /v1/sources" \
    -H "X-Forwarded-Method: GET" \
    -H "X-Forwarded-Uri: /v1/sources" \
    -H "X-Forwarded-Host: 127.0.0.1:8080" \
    -H "X-Forwarded-Proto: http" \
    -H "X-Forwarded-Port: 8080" \
    -H "X-Forwarded-Path: /v1/sources" \
    -H "X-Forwarded-Method: GET" \
    -H "X-Forwarded-Uri: /v1/sources" \
    -H "X-Forwarded-Host: 127.0.0.1:8080" \
    -H "X-Forwarded-Proto: http" \
    -H "X-Forwarded-Port: 8080" \
    -H "X-Forwarded-Path: /v1/sources" \
    -H "X-Forwarded-Method: GET" \
    -H "X-Forwarded-Uri: /v1/sources" \
    -H "X-Forwarded-Host: 127.0.0.1:8080" \
    -H "X-Forwarded-Proto: http" \
    -H "X-Forwarded-Port: 8080" \
    -H "X-Forwarded-Path: /v1/sources" \
    -H "X-Forwarded-Method: GET" \
    -H "X-Forwarded-Uri: /v1/sources" \
    -H "X-Forwarded-Host: 127.0.0.1:8080" \
    -H "X-Forwarded-Proto: http" \
    -H "X-Forwarded-Port: 8080" \
    -H "X-Forwarded-Path: /v1/sources" \
    -H "X-Forwarded-Method: GET" \
    -H "X-Forwarded-Uri: /v1/sources" \
    -H "X-Forwarded-Host: 127.0.0.1:8080" \
    -H "X-Forwarded-Proto: http" \
    -H "X-Forwarded-Port: 8080" \
    -H "X-Forwarded-Path: /v1/sources" \
    -H "X-Forwarded-Method: GET" \
    -H "X-Forwarded-Uri: /v1/sources" \
    -H "X-Forwarded-Host: 127.0.0.1:8080" \
    -H "X-Forwarded-Proto: http" \
    -H "X-Forwarded-Port: 8080" \
    -H "X-Forwarded-Path: /v1/sources" \
    -H "X-Forwarded-Method: GET" \
    -H "X-Forwarded-Uri: /v1/sources" \
    -H "X-Forwarded-Host: 127.0.0.1:8080" \
    -H "X-Forwarded-Proto: http" \
    -H "X-Forwarded-Port: 8080" \
    -H "X-Forwarded-Path: /v1/sources" \
    -H "X-Forwarded-Method: GET" \
    -H "X-Forwarded-Uri: /v1/sources" \
    -H "X-Forwarded-Host: 127.0.0.1:8080" \
    -H "X-Forwarded-Proto: http" \
    -H "X-Forwarded-Port: 8080" \
    -H "X-Forwarded-Path: /v1/sources" \
    -H "X-Forwarded-Method: GET" \
    -H "X-Forwarded-Uri: /v1/sources" \
    -H "X-Forwarded-Host: 127.0.0.1:8080" \
    -H "X-Forwarded-Proto: http" \
    -H "X-Forwarded-Port: 8080" \
    -H "X-Forwarded-Path: /v1/sources" \
    -H "X-Forwarded-Method: GET" \
    -H "X-Forwarded-Uri: /v1/sources" \
    -H "X-Forwarded-Host: 127.0.0.1:8080" \
    -H "X-Forwarded-Proto: http" \
    -H "X-Forwarded-Port: 8080" \
    -H "X-Forwarded-Path: /v1/sources" \
    -H "X-Forwarded-Method: GET" \
    -H "X-Forwarded-Uri: /v1/sources" \
    -H "X-Forwarded-Host: 127.0.0.1:8080" \
    -H "X-Forwarded-Proto: http" \
    -H "X-Forwarded-Port: 8080" \
    -H "X-Forwarded-Path: /v1/sources" \
    -H "X-Forwarded-Method: GET" \
    -H "X-Forwarded-Uri: /v1/sources" \
    -H "X-Forwarded-Host: 127.0.0.1:8080" \
    -H "X-Forwarded-Proto: http" \
    -H "X-Forwarded-Port: 8080" \
    -H "X-Forwarded-Path: /v1/sources" \
    -H "X-Forwarded-Method: GET" \
    -H "X-Forwarded-Uri: /v1/sources" \
    -H "X-Forwarded-Host: 127.0.0.1:8080" \
    -H "X-Forwarded-Proto: http" \
    -H "X-Forwarded-Port: 8080" \
    -H "X-Forwarded-Path: /v1/sources" \
    -H "X-Forwarded-Method: GET" \
    -H "X-Forwarded-Uri: /v1/sources" \
    -H "X-Forwarded-Host: 127.0.0.1:8080" \
    -H "X-Forwarded-Proto: http" \
    -H "X-Forwarded-Port: 8080" \
    -H "X-Forwarded-Path: /v1/sources" \
    -H "X-Forwarded-Method: GET" \
    -H "X-Forwarded-Uri: /v1/sources" \
    -H "X-Forwarded-Host: 127.0.0.1:8080" \
    -H "X-Forwarded-Proto: http" \
    -H "X-Forwarded-Port: 8080" \
    -H "X-Forwarded-Path: /v1/sources" \
    -H "X-Forwarded-Method: GET" \
    -H "X-Forwarded-Uri: /v1/sources" \
    -H "X-Forwarded-Host: 127.0.0.1:8080" \
    -H "X-Forwarded-Proto: http" \
    -H "X-Forwarded-Port: 8080" \
    -H "X-Forwarded-Path: /v1/sources" \
    -H "X-Forwarded-Method: GET" \
    -H "X-Forwarded-Uri: /v1/sources" \
    -H "X-Forwarded-Host: 127.0.0.1:8080" \
    -H "X-Forwarded-Proto: http" \
    -H "X-Forwarded-Port: 8080" \
    -H "X-Forwarded-Path: /v1/sources" \
    -H "X-Forwarded-Method: GET" \
    -H "X-Forwarded-Uri: /v1/sources" \
    -H "X-Forwarded-Host: 127.0.0.1:8080" \
    -H "X-Forwarded-Proto: http" \
    -H "X-Forwarded-Port: 8080" \
    -H "X-Forwarded-Path: /v1/sources" \
    -H "X-Forwarded-Method: GET" \
    -H "X-Forwarded-Uri: /v1/sources" \
    -H "X-Forwarded-Host: 127.0.0.1:8080" \
    -H "X-Forwarded-Proto: http" \
    -H "X-Forwarded-Port: 8080" \
    -H "X-Forwarded-Path: /v1/sources" \
    -H "X-Forwarded-Method: GET" \
    -H "X-Forwarded-Uri: /v1/sources" \
    -H "X-Forwarded-Host: 127.0.0.1:8080" \
    -H "X-Forwarded-Proto: http" \
    -H "X-Forwarded-Port: 8080" \
    -H "X-Forwarded-Path: /v1/sources" \
    -H "X-Forwarded-Method: GET" \
    -H "X-Forwarded-Uri: /v1/sources" \
    -H "X-Forwarded-Host: 127.0.0.1:8080" \
    -H "X-Forwarded-Proto: http" \
    -H "X-Forwarded-Port: 8080" \
    -H "X-Forwarded-Path: /v1/sources" \
    -H "X-Forwarded-Method: GET" \
    -H "X-Forwarded-Uri: /v1/sources" \
    -H "X-Forwarded-Host: 127.0.0.1:8080" \
    -H "X-Forwarded-Proto: http" \
    -H "X-Forwarded-Port: 8080" \
    -H "X-Forwarded-Path: /v1/sources" \
    -H "X-Forwarded-Method: GET" \
    -H "X-Forwarded-Uri: /v1/sources" \
    -H "X-Forwarded-Host: 127.0.0.1:8080" \
    -H "X-Forwarded-Proto: http" \
    -H "X-Forwarded-Port: 8080" \
    -H "X-Forwarded-Path: /v1/sources" \
    -H "X-Forwarded-Method: GET" \
    -H "X-Forwarded-Uri: /v1/sources" \
    -H "X-Forwarded-Host: 127.0.0.1:8080" \
    -H "X-Forwarded-Proto: http" \
    -H "X-Forwarded-Port: 8080" \
    -H "X-Forwarded-Path: /v1/sources" \
    -H "X-Forwarded-Method: GET" \
    -H "X-Forwarded-Uri: /v1/sources" \
    -H "X-Forwarded-Host: 127.0.0.1:8080" \
    -H "X-Forwarded-Proto: http" \
    -H "X-Forwarded-Port: 8080" \
    -H "X-Forwarded-Path: /v1/sources" \
    -H "X-Forwarded-Method: GET" \
    -H "X-Forwarded-Uri: /v1/sources" \
    -H "X-Forwarded-Host: 127.0.0.1:8080" \
    -H "X-Forwarded-Proto: http" \
    -H "X-Forwarded-Port: 8080" \
    -H "X-Forwarded-Path: /v1/sources" \
    -H "X-Forwarded-Method: GET" \
    -H "X-Forwarded-Uri: /v1/sources" \
    -H "X-Forwarded-Host: 127.0.0.1:8080" \
    -H "X-Forwarded-Proto: http" \
    -H "X-Forwarded-Port: 8080" \
    -H "X-Forwarded-Path: /v1/sources" \
    -H "X-Forwarded-Method: GET" \
    -H "X-Forwarded-Uri: /v1/sources" \
    -H "X-Forwarded-Host: 127.0.0.1:8080" \
    -H "X-Forwarded-Proto: http" \
    -H "X-Forwarded-Port: 8080" \
    -H "X-Forwarded-Path: /v1/sources" \
    -H "X-Forwarded-Method: GET" \
    -H "X-Forwarded-Uri: /v1/sources" \
    -H "X-Forwarded-Host: 127.0.0.1:8080" \
    -H "X-Forwarded-Proto: http" \
    -H "X-Forwarded-Port: 8080" \
    -H "X-Forwarded-Path: /v1/sources" \
    -H "X-Forwarded-Method: GET" \
    -H "X-Forwarded-Uri: /v1/sources" \
    -H "X-Forwarded-Host: 127.0.0.1:8080" \
    -H "X-Forwarded-Proto: http" \
    -H "X-Forwarded-Port: 8080" \
    -H "X-Forwarded-Path: /v1/sources" \
    -H "X-Forwarded-Method: GET" \
    -H "X-Forwarded-Uri: /v1/sources" \
    -H "X-Forwarded-Host: 127.0.0.1:8080" \
    -H "X-Forwarded-Proto: http" \
    -H "X-Forwarded-Port: 8080" \
    -H "X-Forwarded-Path: /v1/sources" \
    -H "X-Forwarded-Method: GET" \
    -H "X-Forwarded-Uri: /v1/sources" \
    -H "X-Forwarded-Host: 127.0.0.1:8080" \
    -H "X-Forwarded-Proto: http" \
    -H "X-Forwarded-Port: 8080" \
    -H "X-Forwarded-Path: /v1/sources" \
    -H "X-Forwarded-Method: GET" \
    -H "X-Forwarded-Uri: /v1/sources" \
    -H "X-Forwarded-Host: 127.0.0.1:8080" \
    -H "X-Forwarded-Proto: http" \
    -H "X-Forwarded-Port: 8080" \
    -H "X-Forwarded-Path: /v1/sources" \
    -H "X-Forwarded-Method: GET" \
    -H "X-Forwarded-Uri: /v1/sources" \
    -H "X-Forwarded-Host: 127.0.0.1:8080" \
    -H "X-Forwarded-Proto: http" \
    -H "X-Forwarded-Port: 8080" \
    -H "X-Forwarded-Path: /v1/sources" \
    -H "X-Forwarded-Method: GET" \
    -H "X-Forwarded-Uri: /v1/sources" \
    -H "X-Forwarded-Host: 127.0.0.1:8080" \
    -H "X-Forwarded-Proto: http" \
    -H "X-Forwarded-Port: 8080" \
    -H "X-Forwarded-Path: /v1/sources" \
    -H "X-Forwarded-Method: GET" \
    -H "X-Forwarded-Uri: /v1/sources" \
    -H "X-Forwarded-Host: 127.0.0.1:8080" \
    -H "X-Forwarded-Proto: http" \
    -H "X-Forwarded-Port: 8080" \
    -H "X-Forwarded-Path: /v1/sources" \
    -H "X-Forwarded-Method: GET" \
    -H "X-Forwarded-Uri: /v1/sources" \
    -H "X-Forwarded-Host: 127.0.0.1:8080" \
    -H "X-Forwarded-Proto: http" \
    -H "X-Forwarded-Port: 8080" \
    -H "X-Forwarded-Path: /v1/sources" \
    -H "X-Forwarded-Method: GET" \
    -H "X-Forwarded-Uri: /v1/sources" \
    -H "X-Forwarded-Host: 127.0.0.1:8080" \
    -H "X-Forwarded-Proto: http" \
    -H "X-Forwarded-Port: 8080" \
    -H "X-Forwarded-Path: /v1/sources" \
    -H "X-Forwarded-Method: GET" \
    -H "X-Forwarded-Uri: /v1/sources" \
    -H "X-Forwarded-Host: 127.0.0.1:8080" \
    -H "X-Forwarded-Proto: http" \
    -H "X-Forwarded-Port: 8080" \
    -H "X-Forwarded-Path: /v1/sources" \
    -H "X-Forwarded-Method: GET" \
    -H "X-Forwarded-Uri: /v1/sources" \
    -H "X-Forwarded-Host: 127.0.0.1:8080" \
    -H "X-Forwarded-Proto: http" \
    -H "X-Forwarded-Port: 8080" \
    -H "X-Forwarded-Path: /v1/sources" \
    -H "X-Forwarded-Method: GET" \
    -H "X-Forwarded-Uri: /v1/sources" \
    -H "X-Forwarded-Host: 127.0.0.1:8080" \
    -H "X-Forwarded-Proto: http" \
    -H "X-Forwarded-Port: 8080" \
    -H "X-Forwarded-Path: /v1/sources" \
    -H "X-Forwarded-Method: GET" \
    -H "X-Forwarded-Uri: /v1/sources" \
    -H "X-Forwarded-Host: 127.0.0.1:8080" \
    -H "X-Forwarded-Proto: http" \
    -H "X-Forwarded-Port: 8080" \
    -H "X-Forwarded-Path: /v1/sources" \
    -H "X-Forwarded-Method: GET" \
    -H "X-Forwarded-Uri: /v1/sources" \
    -H "X-Forwarded-Host: 127.0.0.1:8080" \
    -H "X-Forwarded-Proto: http" \
    -H "X-Forwarded-Port: 8080" \
    -H "X-Forwarded-Path: /v1/sources" \
    -H "X-Forwarded-Method: GET" \
    -H "X-Forwarded-Uri: /v1/sources" \
    -H "X-Forwarded-Host: 127.0.0.1:8080" \
    -H "X-Forwarded-Proto: http" \
    -H "X-Forwarded-Port: 8080" \
    -H "X-Forwarded-Path: /v1/sources" \
    -H "X-Forwarded-Method: GET" \
    -H "X-Forwarded-Uri: /v1/sources" \
    -H "X-Forwarded-Host: 127.0.0.1:8080" \
    -H "X-Forwarded-Proto: http" \
    -H "X-Forwarded-Port: 8080" \
    -H "X-Forwarded-Path: /v1/sources" \
    -H "X-Forwarded-Method: GET" \
    -H "X-Forwarded-Uri: /v1/sources" \
    -H "X-Forwarded-Host: 127.0.0.1:8080" \
    -H "X-Forwarded-Proto: http" \
    -H "X-Forwarded-Port: 8080" \
    -H "X-Forwarded-Path: /v1/sources" \
    -H "X-Forwarded-Method: GET" \
    -H "X-Forwarded-Uri: /v1/sources" \
    -H "X-Forwarded-Host: 127.0.0.1:8080" \
    -H "X-Forwarded-Proto: http" \
    -H "X-Forwarded-Port: 8080" \
    -H "X-Forwarded-Path: /v1/sources" \
    -H "X-Forwarded-Method: GET" \
    -H "X-Forwarded-Uri: /v1/sources" \
    -H "X-Forwarded-Host: 127.0.0.1:8080" \
    -H "X-Forwarded-Proto: http" \
    -H "X-Forwarded-Port: 8080" \
    -H "X-Forwarded-Path: /v1/sources" \
    -H "X-Forwarded-Method: GET" \
    -H "X-Forwarded-Uri: /v1/sources" \
    -H "X-Forwarded-Host: 127.0.0.1:8080" \
    -H "X-Forwarded-Proto: http" \
    -H "X-Forwarded-Port: 8080" \
    -H "X-Forwarded-Path: /v1/sources" \
    -H "X-Forwarded-Method: GET" \
    -H "X-Forwarded-Uri: /v1/sources" \
    -H "X-Forwarded-Host: 127.0.0.1:8080" \
    -H "X-Forwarded-Proto: http" \
    -H "X-Forwarded-Port: 8080" \
    -H "X-Forwarded-Path: /v1/sources" \
    -H "X-Forwarded-Method: GET" \
    -H "X-Forwarded-Uri: /v1/sources" \
    -H "X-Forwarded-Host: 127.0.0.1:8080" \
    -H "X-Forwarded-Proto: http" \
    -H "X-Forwarded-Port: 8080" \
    -H "X-Forwarded-Path: /v1/sources" \
    -H "X-Forwarded-Method: GET" \
    -H "X-Forwarded-Uri: /v1/sources" \
    -H "X-Forwarded-Host: 127.0.0.1:8080" \
    -H "X-Forwarded-Proto: http" \
    -H "X-Forwarded-Port: 8080" \
    -H "X-Forwarded-Path: /v1/sources" \
    -H "X-Forwarded-Method: GET" \
    -H "X-Forwarded-Uri: /v1/sources" \
    -H "X-Forwarded-Host: 127.0.0.1:8080" \
    -H "X-Forwarded-Proto: http" \
    -H "X-Forwarded-Port: 8080" \
    -H "X-Forwarded-Path: /v1/sources" \
    -H "X-Forwarded-Method: GET" \
    -H "X-Forwarded-Uri: /v1/sources" \
    -H "X-Forwarded-Host: 127.0.0.1:8080" \
    -H "X-Forwarded-Proto: http" \
    -H "X-Forwarded-Port: 8080" \
    -H "X-Forwarded-Path: /v1/sources" \
    -H "X-Forwarded-Method: GET" \
    -H "X-Forwarded-Uri: /v1/sources" \
    -H "X-Forwarded-Host: 127.0.0.1:8080" \
    -H "X-Forwarded-Proto: http" \
    -H "X-Forwarded-Port: 8080" \
    -H "X-Forwarded-Path: /v1/sources" \
    -H "X-Forwarded-Method: GET" \
    -H "X-Forwarded-Uri: /v1/sources" \
    -H "X-Forwarded-Host: 127.0.0.1:8080" \
    -H "X-Forwarded-Proto: http" \
    -H "X-Forwarded-Port: 8080" \
    -H "X-Forwarded-Path: /v1/sources" \
    -H "X-Forwarded-Method: GET" \
    -H "X-Forwarded-Uri: /v1/sources" \
    -H "X-Forwarded-Host: 127.0.0.1:8080" \
    -H "X-Forwarded-Proto: http" \
    -H "X-Forwarded-Port: 8080" \
    -H "X-Forwarded-Path: /v1/sources" \
    -H "X-Forwarded-Method: GET" \
    -H "X-Forwarded-Uri: /v1/sources" \
    -H "X-Forwarded-Host: 127.0.0.1:8080" \
    -H "X-Forwarded-Proto: http" \
    -H "X-Forwarded-Port: 8080" \
    -H "X-Forwarded-Path: /v1/sources" \
    -H "X-Forwarded-Method: GET" \
    -H "X-Forwarded-Uri: /v1/sources" \
    -H "X-Forwarded-Host: 127.0.0.1:8080" \
    -H "X-Forwarded-Proto: http" \
    -H "X-Forwarded-Port: 8080" \
    -H "X-Forwarded-Path: /v1/sources" \
    -H "X-Forwarded-Method: GET" \
    -H "X-Forwarded-Uri: /v1/sources" \
    -H "X-Forwarded-Host: 127.0.0.1:8080" \
    -H "X-Forwarded-Proto: http" \
    -H "X-Forwarded-Port: 8080" \
    -H "X-Forwarded-Path: /v1/sources" \
    -H "X-Forwarded-Method: GET" \
    -H "X-Forwarded-Uri: /v1/sources" \
    -H "X-Forwarded-Host: 127.0.0.1:8080" \
    -H "X-Forwarded-Proto: http" \
    -H "X-Forwarded-Port: 8080" \
    -H "X-Forwarded-Path: /v1/sources" \
    -H "X-Forwarded-Method: GET" \
    -H "X-Forwarded-Uri: /v1/sources" \
    -H "X-Forwarded-Host: 127.0.0.1:8080" \
    -H "X-Forwarded-Proto: http" \
    -H "X-Forwarded-Port: 8080" \
    -H "X-Forwarded-Path: /v1/sources" \
    -H "X-Forwarded-Method: GET" \
    -H "X-Forwarded-Uri: /v1/sources" \
    -H "X-Forwarded-Host: 127.0.0.1:8080" \
    -H "X-Forwarded-Proto: http" \
    -H "X-Forwarded-Port: 8080" \
    -H "X-Forwarded-Path: /v1/sources" \
    -H "X-Forwarded-Method: GET" \
    -H "X-Forwarded-Uri: /v1/sources" \
    -H "X-Forwarded-Host: 127.0.0.1:8080" \
    -H "X-Forwarded-Proto: http" \
    -H "X-Forwarded-Port: 8080" \
    -H "X-Forwarded-Path: /v1/sources" \
    -H "X-Forwarded-Method: GET" \
    -H "X-Forwarded-Uri: /v1/sources" \
    -H "X-Forwarded-Host: 127.0.0.1:8080" \
    -H "X-Forwarded-Proto: http" \
    -H "X-Forwarded-Port: 8080" \
    -H "X-Forwarded-Path: /v1/sources" \
    -H "X-Forwarded-Method: GET" \
    -H "X-Forwarded-Uri: /v1/sources" \
    -H "X-Forwarded-Host: 127.0.0.1:8080" \
    -H "X-Forwarded-Proto: http" \
    -H "X-Forwarded-Port: 8080" \
    -H "X-Forwarded-Path: /v1/sources" \
    -H "X-Forwarded-Method: GET" \
    -H "X-Forwarded-Uri: /v1/sources" \
    -H "X-Forwarded-Host: 127.0.0.1:8080" \
    -H "X-Forwarded-Proto: http" \
    -H "X-Forwarded-Port: 8080" \
    -H "X-Forwarded-Path: /v1/sources" \
    -H "X-Forwarded-Method: GET" \
    -H "X-Forwarded-Uri: /v1/sources" \
    -H "X-Forwarded-Host: 127.0.0.1:8080" \
    -H "X-Forwarded-Proto: http" \
    -H "X-Forwarded-Port: 8080" \
    -H "X-Forwarded-Path: /v1/sources" \
    -H "X-Forwarded-Method: GET" \
    -H "X-Forwarded-Uri: /v1/sources" \
    -H "X-Forwarded-Host: 127.0.0.1:8080" \
    -H "X-Forwarded-Proto: http" \
    -H "X-Forwarded-Port: 8080" \
    -H "X-Forwarded-Path: /v1/sources" \
    -H "X-Forwarded-Method: GET" \
    -H "X-Forwarded-Uri: /v1/sources" \
    -H "X-Forwarded-Host: 127.0.0.1:8080" \
    -H "X-Forwarded-Proto: http" \
    -H "X-Forwarded-Port: 8080" \
    -H "X-Forwarded-Path: /v1/sources" \
    -H "X-Forwarded-Method: GET" \
    -H "X-Forwarded-Uri: /v1/sources" \
    -H "X-Forwarded-Host: 127.0.0.1:8080" \
    -H "X-Forwarded-Proto: http" \
    -H "X-Forwarded-Port: 8080" \
    -H "X-Forwarded-Path: /v1/sources" \
    -H "X-Forwarded-Method: GET" \
    -H "X-Forwarded-Uri: /v1/sources" \
    -H "X-Forwarded-Host: 127.0.0.1:8080" \
    -H "X-Forwarded-Proto: http" \
    -H "X-Forwarded-Port: 8080" \
    -H "X-Forwarded-Path: /v1/sources" \
    -H "X-Forwarded-Method: GET" \
    -H "X-Forwarded-Uri: /v1/sources" \
    -H "X-Forwarded-Host: 127.0.0.1:8080" \
    -H "X-Forwarded-Proto: http" \
    -H "X-Forwarded-Port: 8080" \
    -H "X-Forwarded-Path: /v1/sources" \
    -H "X-Forwarded-Method: GET" \
    -H "X-Forwarded-Uri: /v1/sources" \
    -H "X-Forwarded-Host: 127.0.0.1:8080" \
    -H "X-Forwarded-Proto: http" \
    -H "X-Forwarded-Port: 8080" \
    -H "X-Forwarded-Path: /v1/sources" \
    -H "X-Forwarded-Method: GET" \
    -H "X-Forwarded-Uri: /v1/sources" \
    -H "X-Forwarded-Host: 127.0.0.1:8080" \
    -H "X-Forwarded-Proto: http" \
    -H "X-Forwarded-Port: 8080" \
    -H "X-Forwarded-Path: /v1/sources" \
    -H "X-Forwarded-Method: GET" \
    -H "X-Forwarded-Uri: /v1/sources" \
    -H "X-Forwarded-Host: 127.0.0.1:8080" \
    -H "X-Forwarded-Proto: http" \
    -H "X-Forwarded-Port: 8080" \
    -H "X-Forwarded-Path: /v1/sources" \
    -H "X-Forwarded-Method: GET" \
    -H "X-Forwarded-Uri: /v1/sources" \
    -H "X-Forwarded-Host: 127.0.0.1:8080" \
    -H "X-Forwarded-Proto: http" \
    -H "X-Forwarded-Port: 8080" \
    -H "X-Forwarded-Path: /v1/sources" \
    -H "X-Forwarded-Method: GET" \
    -H "X-Forwarded-Uri: /v1/sources" \
    -H "X-Forwarded-Host: 127.0.0.1:8080" \
    -H "X-Forwarded-Proto: http" \
    -H "X-Forwarded-Port: 8080" \
    -H "X-Forwarded-Path: /v1/sources" \
    -H "X-Forwarded-Method: GET" \
    -H "X-Forwarded-Uri: /v1/sources" \
    -H "X-Forwarded-Host: 127.0.0.1:8080" \
    -H "X-Forwarded-Proto: http" \
    -H "X-Forwarded-Port: 8080" \
    -H "X-Forwarded-Path: /v1/sources" \
    -H "X-Forwarded-Method: GET" \
    -H "X-Forwarded-Uri: /v1/sources" \
    -H "X-Forwarded-Host: 127.0.0.1:8080" \
    -H "X-Forwarded-Proto: http" \
    -H "X-Forwarded-Port: 8080" \
    -H "X-Forwarded-Path: /v1/sources" \
    -H "X-Forwarded-Method: GET" \
    -H "X-Forwarded-Uri: /v1/sources" \
    -H "X-Forwarded-Host: 127.0.0.1:8080" \
    -H "X-Forwarded-Proto: http" \
    -H "X-Forwarded-Port: 8080" \
    -H "X-Forwarded-Path: /v1/sources" \
    -H "X-Forwarded-Method: GET" \
    -H "X-Forwarded-Uri: /v1/sources" \
    -H "X-Forwarded-Host: 127.0.0.1:8080" \
    -H "X-Forwarded-Proto: http" \
    -H "X-Forwarded-Port: 8080" \
    -H "X-Forwarded-Path: /v1/sources" \
    -H "X-Forwarded-Method: GET" \
    -H "X-Forwarded-Uri: /v1/sources" \
    -H "X-Forwarded-Host: 127.0.0.1:8080" \
    -H "X-Forwarded-Proto: http" \
    -H "X-Forwarded-Port: 8080" \
    -H "X-Forwarded-Path: /v1/sources" \
    -H "X-Forwarded-Method: GET" \
    -H "X-Forwarded-Uri: /v1/sources" \
    -H "X-Forwarded-Host: 127.0.0.1:8080" \
    -H "X-Forwarded-Proto: http" \
    -H "X-Forwarded-Port: 8080" \
    -H "X-Forwarded-Path: /v1/sources" \
    -H "X-Forwarded-Method: GET" \
    -H "X-Forwarded-Uri: /v1/sources" \
    -H "X-Forwarded-Host: 127.0.0.1:8080" \
    -H "X-Forwarded-Proto: http" \
    -H "X-Forwarded-Port: 8080" \
    -H "X-Forwarded-Path: /v1/sources" \
    -H "X-Forwarded-Method: GET" \
    -H "X-Forwarded-Uri: /v1/sources" \
    -H "X-Forwarded-Host: 127.0.0.1:8080" \
    -H "X-Forwarded-Proto: http" \
    -H "X-Forwarded-Port: 8080" \
    -H "X-Forwarded-Path: /v1/sources" \
    -H "X-Forwarded-Method: GET" \
    -H "X-Forwarded-Uri: /v1/sources" \
    -H "X-Forwarded-Host: 127.0.0.1:8080" \
    -H "X-Forwarded-Proto: http" \
    -H "X-Forwarded-Port: 8080" \
    -H "X-Forwarded-Path: /v1/sources" \
    -H "X-Forwarded-Method: GET" \
    -H "X-Forwarded-Uri: /v1/sources" \
    -H "X-Forwarded-Host: 127.0.0.1:8080" \
    -H "X-Forwarded-Proto: http" \
    -H "X-Forwarded-Port: 8080" \
    -H "X-Forwarded-Path: /v1/sources" \
    -H "X-Forwarded-Method: GET" \
    -H "X-Forwarded-Uri: /v1/sources" \
    -H "X-Forwarded-Host: 127.0.0.1:8080" \
    -H "X-Forwarded-Proto: http" \
    -H "X-Forwarded-Port: 8080" \
    -H "X-Forwarded-Path: /v1/sources" \
    -H "X-Forwarded-Method: GET" \
    -H "X-Forwarded-Uri: /v1/sources" \
    -H "X-Forwarded-Host: 127.0.0.1:8080" \
    -H "X-Forwarded-Proto: http" \
    -H "X-Forwarded-Port: 8080" \
    -H "X-Forwarded-Path: /v1/sources" \
    -H "X-Forwarded-Method: GET" \
    -H "X-Forwarded-Uri: /v1/sources" \
    -H "X-Forwarded-Host: 127.0.0.1:8080" \
    -H "X-Forwarded-Proto: http" \
    -H "X-Forwarded-Port: 8080" \
    -H "X-Forwarded-Path: /v1/sources" \
    -H "X-Forwarded-Method: GET" \
    -H "X-Forwarded-Uri: /v1/sources" \
    -H "X-Forwarded-Host: 127.0.0.1:8080" \
    -H "X-Forwarded-Proto: http" \
    -H "X-Forwarded-Port: 8080" \
    -H "X-Forwarded-Path: /v1/sources" \
    -H "X-Forwarded-Method: GET" \
    -H "X-Forwarded-Uri: /v1/sources" \
    -H "X-Forwarded-Host: 127.0.0.1:8080" \
    -H "X-Forwarded-Proto: http" \
    -H "X-Forwarded-Port: 8080" \
    -H "X-Forwarded-Path: /v1/sources" \
    -H "X-Forwarded-Method: GET" \
    -H "X-Forwarded-Uri: /v1/sources" \
    -H "X-Forwarded-Host: 127.0.0.1:8080" \
    -H "X-Forwarded-Proto: http" \
    -H "X-Forwarded-Port: 8080" \
    -H "X-Forwarded-Path: /v1/sources" \
    -H "X-Forwarded-Method: GET" \
    -H "X-Forwarded-Uri: /v1/sources" \
    -H "X-Forwarded-Host: 127.0.0.1:8080" \
    -H "X-Forwarded-Proto: http" \
    -H "X-Forwarded-Port: 8080" \
    -H "X-Forwarded-Path: /v1/sources" \
    -H "X-Forwarded-Method: GET" \
    -H "X-Forwarded-Uri: /v1/sources" \
    -H "X-Forwarded-Host: 127.0.0.1:8080" \
    -H "X-Forwarded-Proto: http" \
    -H "X-Forwarded-Port: 8080" \
    -H "X-Forwarded-Path: /v1/sources" \
    -H "X-Forwarded-Method: GET" \
    -H "X-Forwarded-Uri: /v1/sources" \
    -H "X-Forwarded-Host: 127.0.0.1:8080" \
    -H "X-Forwarded-Proto: http" \
    -H "X-Forwarded-Port: 8080" \
    -H "X-Forwarded-Path: /v1/sources" \
    -H "X-Forwarded-Method: GET" \
    -H "X-Forwarded-Uri: /v1/sources" \
    -H "X-Forwarded-Host: 127.0.0.1:8080" \
    -H "X-Forwarded-Proto: http" \
    -H "X-Forwarded-Port: 8080" \
    -H "X-Forwarded-Path: /v1/sources" \
    -H "X-Forwarded-Method: GET" \
    -H "X-Forwarded-Uri: /v1/sources" \
    -H "X-Forwarded-Host: 127.0.0.1:8080" \
    -H "X-Forwarded-Proto: http" \
    -H "X-Forwarded-Port: 8080" \
    -H "X-Forwarded-Path: /v1/sources" \
    -H "X-Forwarded-Method: GET" \
    -H "X-Forwarded-Uri: /v1/sources" \
    -H "X-Forwarded-Host: 127.0.0.1:8080" \
    -H "X-Forwarded-Proto: http" \
    -H "X-Forwarded-Port: 8080" \
    -H "X-Forwarded-Path: /v1/sources" \
    -H "X-Forwarded-Method: GET" \
    -H "X-Forwarded-Uri: /v1/sources" \
    -H "X-Forwarded-Host: 127.0.0.1:8080" \
    -H "X-Forwarded-Proto: http" \
    -H "X-Forwarded-Port: 8080" \
    -H "X-Forwarded-Path: /v1/sources" \
    -H "X-Forwarded-Method: GET" \
    -H "X-Forwarded-Uri: /v1/sources" \
    -H "X-Forwarded-Host: 127.0.0.1:8080" \
    -H "X-Forwarded-Proto: http" \
    -H "X-Forwarded-Port: 8080" \
    -H "X-Forwarded-Path: /v1/sources" \
    -H "X-Forwarded-Method: GET" \
    -H "X-Forwarded-Uri: /v1/sources" \
    -H "X-Forwarded-Host: 127.0.0.1:8080" \
    -H "X-Forwarded-Proto: http" \
    -H "X-Forwarded-Port: 8080" \
    -H "X-Forwarded-Path: /v1/sources" \
    -H "X-Forwarded-Method: GET" \
    -H "X-Forwarded-Uri: /v1/sources" \
    -H "X-Forwarded-Host: 127.0.0.1:8080" \
    -H "X-Forwarded-Proto: http" \
    -H "X-Forwarded-Port: 8080" \
    -H "X-Forwarded-Path: /v1/sources" \
    -H "X-Forwarded-Method: GET" \
    -H "X-Forwarded-Uri: /v1/sources" \
    -H "X-Forwarded-Host: 127.0.0.1:8080" \
    -H "X-Forwarded-Proto: http" \
    -H "X-Forwarded-Port: 8080" \
    -H "X-Forwarded-Path: /v1/sources" \
    -H "X-Forwarded-Method: GET" \
    -H "X-Forwarded-Uri: /v1/sources" \
    -H "X-Forwarded-Host: 127.0.0.1:8080" \
    -H "X-Forwarded-Proto: http" \
    -H "X-Forwarded-Port: 8080" \
    -H "X-Forwarded-Path: /v1/sources" \
    -H "X-Forwarded-Method: GET" \
    -H "X-Forwarded-Uri: /v1/sources" \
    -H "X-Forwarded-Host: 127.0.0.1:8080" \
    -H "X-Forwarded-Proto: http" \
    -H "X-Forwarded-Port: 8080" \
    -H "X-Forwarded-Path: /v1/sources" \
    -H "X-Forwarded-Method: GET" \
    -H "X-Forwarded-Uri: /v1/sources" \
    -H "X-Forwarded-Host: 127.0.0.1:8080" \
    -H "X-Forwarded-Proto: http" \
    -H "X-Forwarded-Port: 8080" \
    -H "X-Forwarded-Path: /v1/sources" \
    -H "X-Forwarded-Method: GET" \
    -H "X-Forwarded-Uri: /v1/sources" \
    -H "X-Forwarded-Host: 127.0.0.1:8080" \
    -H "X-Forwarded-Proto: http" \
    -H "X-Forwarded-Port: 8080" \
    -H "X-Forwarded-Path: /v1/sources" \
    -H "X-Forwarded-Method: GET" \
    -H "X-Forwarded-Uri: /v1/sources" \
    -H "X-Forwarded-Host: 127.0.0.1:8080" \
    -H "X-Forwarded-Proto: http" \
    -H "X-Forwarded-Port: 8080" \
    -H "X-Forwarded-Path: /v1/sources" \
    -H "X-Forwarded-Method: GET" \
    -H "X-Forwarded-Uri: /v1/sources" \
    -H "X-Forwarded-Host: 127.0.0.1:8080" \
    -H "X-Forwarded-Proto: http" \
    -H "X-Forwarded-Port: 8080" \
    -H "X-Forwarded-Path: /v1/sources" \
    -H "X-Forwarded-Method: GET" \
    -H "X-Forwarded-Uri: /v1/sources" \
    -H "X-Forwarded-Host: 127.0.0.1:8080" \
    -H "X-Forwarded-Proto: http" \
    -H "X-Forwarded-Port: 8080" \
    -H "X-Forwarded-Path: /v1/sources" \
    -H "X-Forwarded-Method: GET" \
    -H "X-Forwarded-Uri: /v1/sources" \
    -H "X-Forwarded-Host: 127.0.0.1:8080" \
    -H "X-Forwarded-Proto: http" \
    -H "X-Forwarded-Port: 8080" \
    -H "X-Forwarded-Path: /v1/sources" \
    -H "X-Forwarded-Method: GET" \
    -H "X-Forwarded-Uri: /v1/sources" \
    -H "X-Forwarded-Host: 127.0.0.1:8080" \
    -H "X-Forwarded-Proto: http" \
    -H "X-Forwarded-Port: 8080" \
    -H "X-Forwarded-Path: /v1/sources" \
    -H "X-Forwarded-Method: GET" \
    -H "X-Forwarded-Uri: /v1/sources" \
    -H "X-Forwarded-Host: 127.0.0.1:8080" \
    -H "X-Forwarded-Proto: http" \
    -H "X-Forwarded-Port: 8080" \
    -H "X-Forwarded-Path: /v1/sources" \
    -H "X-Forwarded-Method: GET" \
    -H "X-Forwarded-Uri: /v1/sources" \
    -H "X-Forwarded-Host: 127.0.0.1:8080" \
    -H "X-Forwarded-Proto: http" \
    -H "X-Forwarded-Port: 8080" \
    -H "X-Forwarded-Path: /v1/sources" \
    -H "X-Forwarded-Method: GET" \
    -H "X-Forwarded-Uri: /v1/sources" \
    -H "X-Forwarded-Host: 127.0.0.1:8080" \
    -H "X-Forwarded-Proto: http" \
    -H "X-Forwarded-Port: 8080" \
    -H "X-Forwarded-Path: /v1/sources" \
    -H "X-Forwarded-Method: GET" \
    -H "X-Forwarded-Uri: /v1/sources" \
    -H "X-Forwarded-Host: 127.0.0.1:8080" \
    -H "X-Forwarded-Proto: http" \
    -H "X-Forwarded-Port: 8080" \
    -H "X-Forward
log "error envelope / request-id (single request)"
RID_HDR="$(mktemp)"; RID_BODY="$(mktemp)"
curl -sS -D "$RID_HDR" "$BASE/__nope__" -o "$RID_BODY" >/dev/null 2>&1 || true
HDR_ID="$(awk 'BEGIN{IGNORECASE=1}/^x-request-id:/{gsub(/\r/,"");print $2}' "$RID_HDR")"
BODY_ID="$(jq -r '.request_id' "$RID_BODY" 2>/dev/null || echo '')"
echo "header=$HDR_ID body=$BODY_ID"
[ -n "$HDR_ID" ] && [ "$HDR_ID" = "$BODY_ID" ] || { echo "request-id mismatch"; exit 1; }

log "trend HEAD (200 headers-only)"
curl -sS -I -H "$API_HEADER" "$BASE/v1/ports/$UNLOCODE/trend?days=7&fields=vessels&format=csv" \
 | sed -n '1p' | grep -q "200" || { echo "HEAD not 200"; exit 1; }
cmdor log "sources HEAD (200)"
curl -sS -I "$BASE/v1/sources" | awk 'BEGIN{IGNORECASE=1}/^(HTTP|cache-control:)/{gsub(/\r/,"");print}' \
  | sed -n '1p' | grep -q "200" || { echo "HEAD /v1/sources not 200"; exit 1; }
